<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Executing Focus</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #020617; color: white; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: sans-serif; overflow: hidden; }
        #timer { font-family: 'JetBrains Mono'; font-size: clamp(5rem, 20vw, 9rem); margin: 10px 0; text-shadow: 0 0 30px rgba(139, 92, 246, 0.4); }
        #task { color: #8b5cf6; letter-spacing: 5px; font-weight: 800; font-size: 1rem; opacity: 0.8; }
        .controls { display: flex; gap: 15px; margin-top: 20px; }
        button { background: #8b5cf6; border: none; color: white; padding: 20px 50px; border-radius: 50px; cursor: pointer; font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(139,92,246,0.3); }
        .exit { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 20px 30px; }
    </style>
</head>
<body>
    <div id="task">INITIALIZING...</div>
    <div id="timer">25:00</div>
    <div class="controls">
        <button id="mainBtn" onclick="toggleTimer()">ENGAGE</button>
        <button class="exit" onclick="window.location.href='index.html'">EXIT</button>
    </div>

<script>
    const mission = JSON.parse(localStorage.getItem("activeChapter"));
    const prod = JSON.parse(localStorage.getItem("productivity")) || { score: 0, sessionsStarted: 0, sessionsCompleted: 0, pauses: 0, focusSecondsToday: 0 };
    let timeLeft = 1500;
    let running = false;
    let interval;

    if(mission) document.getElementById("task").textContent = mission.name.toUpperCase();

    function toggleTimer() {
        if(running) {
            clearInterval(interval);
            prod.pauses++;
            running = false;
            document.getElementById("mainBtn").textContent = "RESUME";
        } else {
            if(timeLeft === 1500) prod.sessionsStarted++;
            running = true;
            document.getElementById("mainBtn").textContent = "PAUSE";
            interval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                if(timeLeft <= 0) finish();
            }, 1000);
        }
        localStorage.setItem("productivity", JSON.stringify(prod));
    }

    function updateDisplay() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        document.getElementById("timer").textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function finish() {
        clearInterval(interval);
        prod.sessionsCompleted++;
        prod.focusSecondsToday += 1500;
        
        // Dynamic Scoring Logic
        const focusScore = Math.min(prod.focusSecondsToday / 14400, 1) * 60;
        const discipline = (prod.sessionsCompleted / prod.sessionsStarted) * 40;
        prod.score = Math.round(focusScore + (discipline || 0));

        localStorage.setItem("productivity", JSON.stringify(prod));
        alert("Session Complete! Focus stored.");
        window.location.href = "index.html";
    }
</script>
</body>
</html>
